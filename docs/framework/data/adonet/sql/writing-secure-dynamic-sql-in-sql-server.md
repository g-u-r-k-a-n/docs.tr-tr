---
description: 'Hakkında daha fazla bilgi edinin: SQL Server güvenli dinamik SQL yazma'
title: SQL Server’da Secure Dynamic SQL Yazma
ms.date: 03/30/2017
ms.assetid: df5512b0-c249-40d2-82f9-f9a2ce6665bc
ms.openlocfilehash: 35db22358bae1150a80daa72cf4a86ef8fba9620
ms.sourcegitcommit: ddf7edb67715a5b9a45e3dd44536dabc153c1de0
ms.translationtype: MT
ms.contentlocale: tr-TR
ms.lasthandoff: 02/06/2021
ms.locfileid: "99766952"
---
# <a name="writing-secure-dynamic-sql-in-sql-server"></a><span data-ttu-id="2967a-103">SQL Server’da Secure Dynamic SQL Yazma</span><span class="sxs-lookup"><span data-stu-id="2967a-103">Writing Secure Dynamic SQL in SQL Server</span></span>

<span data-ttu-id="2967a-104">SQL ekleme, kötü amaçlı bir kullanıcının geçerli giriş yerine Transact-SQL deyimlerini girdiği işlemdir.</span><span class="sxs-lookup"><span data-stu-id="2967a-104">SQL Injection is the process by which a malicious user enters Transact-SQL statements instead of valid input.</span></span> <span data-ttu-id="2967a-105">Giriş, doğrulamadan doğrudan sunucuya geçiriliyorsa ve uygulama eklenen kodu yanlışlıkla çalıştırırsa, saldırı, verileri hasar veya yok etme potansiyelini ister.</span><span class="sxs-lookup"><span data-stu-id="2967a-105">If the input is passed directly to the server without being validated and if the application inadvertently executes the injected code, the attack has the potential to damage or destroy data.</span></span>  
  
 <span data-ttu-id="2967a-106">SQL Server sözdizimsel açıdan geçerli olan aldığı tüm sorguları yürüttüğü için SQL deyimleri oluşturan her türlü yordam, ekleme güvenlik açıklarına karşı gözden geçirilmelidir.</span><span class="sxs-lookup"><span data-stu-id="2967a-106">Any procedure that constructs SQL statements should be reviewed for injection vulnerabilities because SQL Server will execute all syntactically valid queries that it receives.</span></span> <span data-ttu-id="2967a-107">Parametreli veriler bile nitelikli ve belirlenmiş bir saldırgan tarafından yönetilebilir.</span><span class="sxs-lookup"><span data-stu-id="2967a-107">Even parameterized data can be manipulated by a skilled and determined attacker.</span></span> <span data-ttu-id="2967a-108">Dinamik SQL kullanıyorsanız, komutlarınızı parametreleştirilediğinizden ve parametre değerlerini hiçbir şekilde doğrudan sorgu dizesine eklemeyin.</span><span class="sxs-lookup"><span data-stu-id="2967a-108">If you use dynamic SQL, be sure to parameterize your commands, and never include parameter values directly into the query string.</span></span>  
  
## <a name="anatomy-of-a-sql-injection-attack"></a><span data-ttu-id="2967a-109">SQL ekleme saldırısının anatomumu</span><span class="sxs-lookup"><span data-stu-id="2967a-109">Anatomy of a SQL Injection Attack</span></span>  

 <span data-ttu-id="2967a-110">Ekleme işlemi, bir metin dizesini erken sonlandırarak ve yeni bir komut ekleyerek işe yarar.</span><span class="sxs-lookup"><span data-stu-id="2967a-110">The injection process works by prematurely terminating a text string and appending a new command.</span></span> <span data-ttu-id="2967a-111">Eklenen komuta, yürütülmeden önce başka dizeler eklenmiş olabileceğinden, malefaktör eklenen dizeyi "--" Açıklama işaretiyle sonlandırır.</span><span class="sxs-lookup"><span data-stu-id="2967a-111">Because the inserted command may have additional strings appended to it before it is executed, the malefactor terminates the injected string with a comment mark "--".</span></span> <span data-ttu-id="2967a-112">Sonraki metin, yürütme sırasında yok sayılır.</span><span class="sxs-lookup"><span data-stu-id="2967a-112">Subsequent text is ignored at execution time.</span></span> <span data-ttu-id="2967a-113">Noktalı virgül kullanılarak birden çok komut eklenebilir (;) ayırıcı.</span><span class="sxs-lookup"><span data-stu-id="2967a-113">Multiple commands can be inserted using a semicolon (;) delimiter.</span></span>  
  
 <span data-ttu-id="2967a-114">Eklenen SQL kodu sözdizimsel olarak doğru olduğundan, bu değişiklik programlı bir şekilde algılanamıyor.</span><span class="sxs-lookup"><span data-stu-id="2967a-114">As long as injected SQL code is syntactically correct, tampering cannot be detected programmatically.</span></span> <span data-ttu-id="2967a-115">Bu nedenle, tüm kullanıcı girdilerini doğrulamanız ve kullanmakta olduğunuz sunucuda oluşturulmuş SQL komutlarını yürüten kodu dikkatle incelemeniz gerekir.</span><span class="sxs-lookup"><span data-stu-id="2967a-115">Therefore, you must validate all user input and carefully review code that executes constructed SQL commands in the server that you are using.</span></span> <span data-ttu-id="2967a-116">Doğrulanmamış olmayan kullanıcı girişini hiçbir şekilde birleştirme.</span><span class="sxs-lookup"><span data-stu-id="2967a-116">Never concatenate user input that is not validated.</span></span> <span data-ttu-id="2967a-117">Dize birleştirme, betik ekleme için birincil giriş noktasıdır.</span><span class="sxs-lookup"><span data-stu-id="2967a-117">String concatenation is the primary point of entry for script injection.</span></span>  
  
 <span data-ttu-id="2967a-118">Faydalı yönergeler aşağıda verilmiştir:</span><span class="sxs-lookup"><span data-stu-id="2967a-118">Here are some helpful guidelines:</span></span>  
  
- <span data-ttu-id="2967a-119">Transact-SQL deyimlerini hiçbir şekilde doğrudan Kullanıcı girişinden oluşturun; Kullanıcı girişini doğrulamak için saklı yordamları kullanın.</span><span class="sxs-lookup"><span data-stu-id="2967a-119">Never build Transact-SQL statements directly from user input; use stored procedures to validate user input.</span></span>  
  
- <span data-ttu-id="2967a-120">Tür, uzunluk, biçim ve Aralık test ederek Kullanıcı girişini doğrulayın.</span><span class="sxs-lookup"><span data-stu-id="2967a-120">Validate user input by testing type, length, format, and range.</span></span> <span data-ttu-id="2967a-121">Bir dizedeki herhangi bir karakteri atlamak için sistem adlarını veya REPLACE () işlevini kaçış için Transact-SQL QUOTENAME () işlevini kullanın.</span><span class="sxs-lookup"><span data-stu-id="2967a-121">Use the Transact-SQL QUOTENAME() function to escape system names or the REPLACE() function to escape any character in a string.</span></span>  
  
- <span data-ttu-id="2967a-122">Uygulamanızın her katmanında birden çok doğrulama katmanı uygulayın.</span><span class="sxs-lookup"><span data-stu-id="2967a-122">Implement multiple layers of validation in each tier of your application.</span></span>  
  
- <span data-ttu-id="2967a-123">Girişin boyutunu ve veri türünü test edin ve uygun sınırları uygulayın.</span><span class="sxs-lookup"><span data-stu-id="2967a-123">Test the size and data type of input and enforce appropriate limits.</span></span> <span data-ttu-id="2967a-124">Bu, bilinçli arabellek taşmalarını önlemeye yardımcı olabilir.</span><span class="sxs-lookup"><span data-stu-id="2967a-124">This can help prevent deliberate buffer overruns.</span></span>  
  
- <span data-ttu-id="2967a-125">Dize değişkenlerinin içeriğini test edin ve yalnızca beklenen değerleri kabul edin.</span><span class="sxs-lookup"><span data-stu-id="2967a-125">Test the content of string variables and accept only expected values.</span></span> <span data-ttu-id="2967a-126">İkili veri, kaçış dizileri ve Açıklama karakterleri içeren girişleri reddedin.</span><span class="sxs-lookup"><span data-stu-id="2967a-126">Reject entries that contain binary data, escape sequences, and comment characters.</span></span>  
  
- <span data-ttu-id="2967a-127">XML belgeleriyle çalışırken, girilen tüm verileri şemaya göre doğrulayın.</span><span class="sxs-lookup"><span data-stu-id="2967a-127">When you are working with XML documents, validate all data against its schema as it is entered.</span></span>  
  
- <span data-ttu-id="2967a-128">Çok katmanlı ortamlarda, tüm verilerin güvenilen bölgeye bağlanmadan önce doğrulanması gerekir.</span><span class="sxs-lookup"><span data-stu-id="2967a-128">In multi-tiered environments, all data should be validated before admission to the trusted zone.</span></span>  
  
- <span data-ttu-id="2967a-129">Dosya adlarının oluşturulabileceği alanlarda aşağıdaki dizeleri kabul etme: AUX, saat $, COM1 aracılığıyla COM8, CON, CONFIG $, LPT1 ile LPT8, NUL ve PRN.</span><span class="sxs-lookup"><span data-stu-id="2967a-129">Do not accept the following strings in fields from which file names can be constructed: AUX, CLOCK$, COM1 through COM8, CON, CONFIG$, LPT1 through LPT8, NUL, and PRN.</span></span>  
  
- <span data-ttu-id="2967a-130"><xref:System.Data.SqlClient.SqlParameter>Tür denetimi ve uzunluk doğrulaması sağlamak için saklı yordam ve komutlarla nesneleri kullanın.</span><span class="sxs-lookup"><span data-stu-id="2967a-130">Use <xref:System.Data.SqlClient.SqlParameter> objects with stored procedures and commands to provide type checking and length validation.</span></span>  
  
- <span data-ttu-id="2967a-131"><xref:System.Text.RegularExpressions.Regex>Geçersiz karakterleri filtrelemek için istemci kodundaki ifadeleri kullanın.</span><span class="sxs-lookup"><span data-stu-id="2967a-131">Use <xref:System.Text.RegularExpressions.Regex> expressions in client code to filter invalid characters.</span></span>  
  
## <a name="dynamic-sql-strategies"></a><span data-ttu-id="2967a-132">Dinamik SQL stratejileri</span><span class="sxs-lookup"><span data-stu-id="2967a-132">Dynamic SQL Strategies</span></span>  

 <span data-ttu-id="2967a-133">Yordamsal kodunuzda dinamik olarak oluşturulan SQL deyimlerini yürütmek, sahiplik zincirini bozar ve bu da, dinamik SQL tarafından erişilmekte olan nesnelere karşı çağıranın izinlerini denetlemesini SQL Server olur.</span><span class="sxs-lookup"><span data-stu-id="2967a-133">Executing dynamically created SQL statements in your procedural code breaks the ownership chain, causing SQL Server to check the permissions of the caller against the objects being accessed by the dynamic SQL.</span></span>  
  
 <span data-ttu-id="2967a-134">SQL Server, kullanıcılara saklı yordamları ve dinamik SQL çalıştıran kullanıcı tanımlı işlevleri kullanarak veri erişimi verme yöntemlerine sahiptir.</span><span class="sxs-lookup"><span data-stu-id="2967a-134">SQL Server has methods for granting users access to data using stored procedures and user-defined functions that execute dynamic SQL.</span></span>  
  
- <span data-ttu-id="2967a-135">[SQL Server ' de kimliğe bürünme Ile Izinleri özelleştirme](customizing-permissions-with-impersonation-in-sql-server.md)bölümünde açıklandığı gibi Transact-SQL execute as yan tümcesiyle kimliğe bürünme özelliğini kullanma.</span><span class="sxs-lookup"><span data-stu-id="2967a-135">Using impersonation with the Transact-SQL EXECUTE AS clause, as described in [Customizing Permissions with Impersonation in SQL Server](customizing-permissions-with-impersonation-in-sql-server.md).</span></span>  
  
- <span data-ttu-id="2967a-136">Saklı yordamları [SQL Server 'de imzalama](signing-stored-procedures-in-sql-server.md)bölümünde açıklandığı gibi sertifikalarla imzalama.</span><span class="sxs-lookup"><span data-stu-id="2967a-136">Signing stored procedures with certificates, as described in [Signing Stored Procedures in SQL Server](signing-stored-procedures-in-sql-server.md).</span></span>  
  
### <a name="execute-as"></a><span data-ttu-id="2967a-137">FARKLı ÇALıŞTıR</span><span class="sxs-lookup"><span data-stu-id="2967a-137">EXECUTE AS</span></span>  

 <span data-ttu-id="2967a-138">EXECUTE AS yan tümcesi, çağıran öğesinin, EXECUTE AS yan tümcesinde belirtilen kullanıcının izinleriyle değiştirir.</span><span class="sxs-lookup"><span data-stu-id="2967a-138">The EXECUTE AS clause replaces the permissions of the caller with that of the user specified in the EXECUTE AS clause.</span></span> <span data-ttu-id="2967a-139">İç içe saklı yordamlar veya Tetikleyiciler, proxy kullanıcısının güvenlik bağlamı altında yürütülür.</span><span class="sxs-lookup"><span data-stu-id="2967a-139">Nested stored procedures or triggers execute under the security context of the proxy user.</span></span> <span data-ttu-id="2967a-140">Bu, satır düzeyi güvenliğe dayanan veya denetim gerektiren uygulamaları bozabilir.</span><span class="sxs-lookup"><span data-stu-id="2967a-140">This can break applications that rely on row-level security or require auditing.</span></span> <span data-ttu-id="2967a-141">Kullanıcının kimliğini döndüren bazı işlevler, özgün çağıranı değil, EXECUTE AS yan tümcesinde belirtilen kullanıcıyı döndürür.</span><span class="sxs-lookup"><span data-stu-id="2967a-141">Some functions that return the identity of the user return the user specified in the EXECUTE AS clause, not the original caller.</span></span> <span data-ttu-id="2967a-142">Yürütme bağlamı, yalnızca yordamın yürütülmesinden sonra veya bir GERI alma yöntemi verildiğinde özgün çağırana döndürülür.</span><span class="sxs-lookup"><span data-stu-id="2967a-142">Execution context is reverted to the original caller only after execution of the procedure or when a REVERT statement is issued.</span></span>  
  
### <a name="certificate-signing"></a><span data-ttu-id="2967a-143">Sertifika İmzalama</span><span class="sxs-lookup"><span data-stu-id="2967a-143">Certificate Signing</span></span>  

 <span data-ttu-id="2967a-144">Bir sertifikayla imzalanmış bir saklı yordam yürütüldüğünde, sertifika kullanıcısına verilen izinler çağıranların ile birleştirilir.</span><span class="sxs-lookup"><span data-stu-id="2967a-144">When a stored procedure that has been signed with a certificate executes, the permissions granted to the certificate user are merged with those of the caller.</span></span> <span data-ttu-id="2967a-145">Yürütme bağlamı aynı kalır; Sertifika kullanıcısı çağıranın kimliğine bürünemez.</span><span class="sxs-lookup"><span data-stu-id="2967a-145">The execution context remains the same; the certificate user does not impersonate the caller.</span></span> <span data-ttu-id="2967a-146">İmzalama saklı yordamlarını uygulamak için birkaç adım gerekir.</span><span class="sxs-lookup"><span data-stu-id="2967a-146">Signing stored procedures requires several steps to implement.</span></span> <span data-ttu-id="2967a-147">Yordamın her değiştirildiği her seferinde yeniden imzalanması gerekir.</span><span class="sxs-lookup"><span data-stu-id="2967a-147">Each time the procedure is modified, it must be re-signed.</span></span>  
  
### <a name="cross-database-access"></a><span data-ttu-id="2967a-148">Çapraz veritabanı erişimi</span><span class="sxs-lookup"><span data-stu-id="2967a-148">Cross Database Access</span></span>  

 <span data-ttu-id="2967a-149">Veritabanları arası sahiplik zinciri, dinamik olarak oluşturulan SQL deyimlerinin yürütüldüğü durumlarda çalışmaz.</span><span class="sxs-lookup"><span data-stu-id="2967a-149">Cross-database ownership chaining does not work in cases where dynamically created SQL statements are executed.</span></span> <span data-ttu-id="2967a-150">Başka bir veritabanındaki verilere erişen ve yordamı her iki veritabanında bulunan bir sertifikayla imzalayan bir saklı yordam oluşturarak bu SQL Server geçici bir çözüm bulabilirsiniz.</span><span class="sxs-lookup"><span data-stu-id="2967a-150">You can work around this in SQL Server by creating a stored procedure that accesses data in another database and signing the procedure with a certificate that exists in both databases.</span></span> <span data-ttu-id="2967a-151">Bu, kullanıcılara veritabanı erişimi veya izinleri vermeden yordam tarafından kullanılan veritabanı kaynaklarına erişim sağlar.</span><span class="sxs-lookup"><span data-stu-id="2967a-151">This gives users access to the database resources used by the procedure without granting them database access or permissions.</span></span>  
  
## <a name="external-resources"></a><span data-ttu-id="2967a-152">Dış Kaynaklar</span><span class="sxs-lookup"><span data-stu-id="2967a-152">External Resources</span></span>  

 <span data-ttu-id="2967a-153">Daha fazla bilgi için aşağıdaki kaynaklara bakın.</span><span class="sxs-lookup"><span data-stu-id="2967a-153">For more information, see the following resources.</span></span>  
  
|<span data-ttu-id="2967a-154">Kaynak</span><span class="sxs-lookup"><span data-stu-id="2967a-154">Resource</span></span>|<span data-ttu-id="2967a-155">Açıklama</span><span class="sxs-lookup"><span data-stu-id="2967a-155">Description</span></span>|  
|--------------|-----------------|  
|<span data-ttu-id="2967a-156">SQL Server Books Online 'da [saklı yordamlar](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) ve [SQL ekleme](/sql/relational-databases/security/sql-injection)</span><span class="sxs-lookup"><span data-stu-id="2967a-156">[Stored Procedures](/sql/relational-databases/stored-procedures/stored-procedures-database-engine) and [SQL Injection](/sql/relational-databases/security/sql-injection) in SQL Server Books Online</span></span>|<span data-ttu-id="2967a-157">Konular, saklı yordamların nasıl oluşturulduğunu ve SQL ekleme 'nin nasıl çalıştığını açıklamaktadır.</span><span class="sxs-lookup"><span data-stu-id="2967a-157">Topics describe how to create stored procedures and how SQL Injection works.</span></span>|  
  
## <a name="see-also"></a><span data-ttu-id="2967a-158">Ayrıca bkz.</span><span class="sxs-lookup"><span data-stu-id="2967a-158">See also</span></span>

- [<span data-ttu-id="2967a-159">ADO.NET Uygulamalarının Güvenliğini Sağlama</span><span class="sxs-lookup"><span data-stu-id="2967a-159">Securing ADO.NET Applications</span></span>](../securing-ado-net-applications.md)
- [<span data-ttu-id="2967a-160">SQL Server Güvenliğine Genel Bakış</span><span class="sxs-lookup"><span data-stu-id="2967a-160">Overview of SQL Server Security</span></span>](overview-of-sql-server-security.md)
- [<span data-ttu-id="2967a-161">SQL Server'da Uygulama Güvenliği Senaryoları</span><span class="sxs-lookup"><span data-stu-id="2967a-161">Application Security Scenarios in SQL Server</span></span>](application-security-scenarios-in-sql-server.md)
- [<span data-ttu-id="2967a-162">SQL Server'da Saklı Yordam İzinlerini Yönetme</span><span class="sxs-lookup"><span data-stu-id="2967a-162">Managing Permissions with Stored Procedures in SQL Server</span></span>](managing-permissions-with-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="2967a-163">SQL Server'da Saklı Yordam İmzalama</span><span class="sxs-lookup"><span data-stu-id="2967a-163">Signing Stored Procedures in SQL Server</span></span>](signing-stored-procedures-in-sql-server.md)
- [<span data-ttu-id="2967a-164">SQL Server'da Kimliğe Bürünme İzinlerini Özelleştirme</span><span class="sxs-lookup"><span data-stu-id="2967a-164">Customizing Permissions with Impersonation in SQL Server</span></span>](customizing-permissions-with-impersonation-in-sql-server.md)
- [<span data-ttu-id="2967a-165">ADO.NET’e Genel Bakış</span><span class="sxs-lookup"><span data-stu-id="2967a-165">ADO.NET Overview</span></span>](../ado-net-overview.md)
